!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).KintoClient=e()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};function e(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}var r=function(){return(r=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function i(t,e,r,i){var n,o=arguments.length,s=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(s=(o<3?n(s):o>3?n(e,r,s):n(e,r))||s);return o>3&&s&&Object.defineProperty(e,r,s),s}function n(t,e,r,i){return new(r||(r=Promise))((function(n,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,a)}u((i=i.apply(t,e||[])).next())}))}function o(t,e){var r,i,n,o,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(n=2&o[0]?i.return:o[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,o[1])).done)return n;switch(i=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(n=(n=s.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){s.label=o[1];break}if(6===o[0]&&s.label<n[1]){s.label=n[1],n=o;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(o);break}n[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function s(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],i=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s}function u(t){if(l(t))return t;if("string"==typeof t)return{id:t};throw new Error("Invalid argument.")}function c(t){var e=function(t){return encodeURIComponent("boolean"==typeof t?String(t):t)},r=v(t);return Object.keys(r).map((function(t){var i=e(t)+"=";return Array.isArray(r[t])?i+r[t].map((function(t){return e(t)})).join(","):i+e(r[t])})).join("&")}function h(t,e,r){var i=function(t){return t.split(".").map((function(t){return parseInt(t,10)}))},n=a(i(t),2),o=n[0],s=n[1],u=a(i(e),2),c=u[0],h=u[1],d=a(i(r),2),f=d[0],l=d[1];if([o<c,o===c&&s<h,o>f,o===f&&s>=l].some((function(t){return t})))throw new Error("Version "+t+" doesn't satisfy "+e+" <= x < "+r)}function d(t){return function(e,r,i){var n=i.value;return{configurable:!0,get:function(){var e=this,i=function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];var o=e.client?e.client:e;return o.fetchServerCapabilities().then((function(e){var r=t.filter((function(t){return!(t in e)}));if(r.length>0){var i=r.join(", ");throw new Error("Required capabilities "+i+" not present on server")}})).then((function(){return n.apply(e,r)}))};return Object.defineProperty(this,r,{value:i,configurable:!0,writable:!0}),i}}}}function f(t){return function(e,r,i){var n=i.value;return{configurable:!0,get:function(){var e=this,i=function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];if(e._isBatch)throw new Error(t);return n.apply(e,r)};return Object.defineProperty(this,r,{value:i,configurable:!0,writable:!0}),i}}}}function l(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function p(t){for(var e=function(t){var e=t.match(/^data:(.*);base64,(.*)/);if(!e)throw new Error("Invalid data-url: "+String(t).substr(0,32)+"...");var i=e[1],n=e[2],o=a(i.split(";")),s=o[0],u=o.slice(1).reduce((function(t,e){var i,n=a(e.split("="),2),o=n[0],s=n[1];return r(r({},t),((i={})[o]=s,i))}),{});return r(r({},u),{type:s,base64:n})}(t),i=e.name,n=e.type,o=e.base64,s=atob(o),u=[],c=0;c<s.length;c++)u.push(s.charCodeAt(c));return{blob:new Blob([new Uint8Array(u)],{type:n}),name:i}}function v(t){var e={};for(var r in t)void 0!==t[r]&&(e[r]=t[r]);return e}function y(t){var e,r,i=new Headers(t);i.has("authorization")&&i.set("authorization","**** (suppressed)");var n={};try{for(var o=s(i.entries()),u=o.next();!u.done;u=o.next()){var c=a(u.value,2),h=c[0],d=c[1];n[h]=d}}catch(t){e={error:t}}finally{try{u&&!u.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}return n}var g={104:"Missing Authorization Token",105:"Invalid Authorization Token",106:"Request body was not valid JSON",107:"Invalid request parameter",108:"Missing request parameter",109:"Invalid posted data",110:"Invalid Token / id",111:"Missing Token / id",112:"Content-Length header was not provided",113:"Request body too large",114:"Resource was created, updated or deleted meanwhile",115:"Method not allowed on this end point (hint: server may be readonly)",116:"Requested version not available on this server",117:"Client has sent too many requests",121:"Resource access is forbidden for this user",122:"Another resource violates constraint",201:"Service Temporary unavailable due to high load",202:"Service deprecated",999:"Internal Server Error"},m=function(t){function r(e,i){var n=t.call(this,"Timeout while trying to access "+e+" with "+JSON.stringify(i))||this;return Error.captureStackTrace&&Error.captureStackTrace(n,r),n.url=e,n.options=i,n}return e(r,t),r}(Error),_=function(t){function r(e,i,n){var o=this,s=e.status;return o=t.call(this,"Response from server unparseable (HTTP "+(s||0)+"; "+n+"): "+i)||this,Error.captureStackTrace&&Error.captureStackTrace(o,r),o.status=s,o.response=e,o.stack=n.stack,o.error=n,o}return e(r,t),r}(Error),b=function(t){function r(e,i){var n,o=this,s=e.status,a=e.statusText;i&&(a=i.error||a,i.errno&&i.errno in g?n=g[i.errno]:i.message&&(n=i.message),n&&i.message&&i.message!==n&&(n+=" ("+i.message+")"));var u="HTTP "+s+" "+a;return n&&(u+=": "+n),o=t.call(this,u.trim())||this,Error.captureStackTrace&&Error.captureStackTrace(o,r),o.response=e,o.data=i,o}return e(r,t),r}(Error),w=function(){function t(e,r){void 0===r&&(r={}),this.events=e,this.requestMode=r.requestMode||t.defaultOptions.requestMode,this.timeout=r.timeout||t.defaultOptions.timeout}return Object.defineProperty(t,"DEFAULT_REQUEST_HEADERS",{get:function(){return{Accept:"application/json","Content-Type":"application/json"}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"defaultOptions",{get:function(){return{timeout:null,requestMode:"cors"}},enumerable:!0,configurable:!0}),t.prototype.timedFetch=function(t,e){var i=this,n=!1;return new Promise((function(o,s){var a;function u(t){return function(e){n||(a&&clearTimeout(a),t(e))}}i.timeout&&(a=setTimeout((function(){n=!0,e&&e.headers&&(e=r(r({},e),{headers:y(e.headers)})),s(new m(t,e))}),i.timeout)),fetch(t,e).then(u(o)).catch(u(s))}))},t.prototype.processResponse=function(t){return n(this,void 0,void 0,(function(){var e,r,i,n;return o(this,(function(o){switch(o.label){case 0:return e=t.status,r=t.headers,[4,t.text()];case 1:if(0!==(i=o.sent()).length)try{n=JSON.parse(i)}catch(e){throw new _(t,i,e)}if(e>=400)throw new b(t,n);return[2,{status:e,json:n,headers:r}]}}))}))},t.prototype.retry=function(t,e,i,s){return n(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return[4,(o=e,new Promise((function(t){return setTimeout(t,o)})))];case 1:return n.sent(),[2,this.request(t,i,r(r({},s),{retry:s.retry-1}))]}var o}))}))},t.prototype.request=function(e,i,s){return void 0===i&&(i={headers:{}}),void 0===s&&(s={retry:0}),n(this,void 0,void 0,(function(){var n,a,u;return o(this,(function(o){switch(o.label){case 0:return i.headers=r(r({},t.DEFAULT_REQUEST_HEADERS),i.headers),i.body&&i.body instanceof FormData&&(i.headers instanceof Headers?i.headers.delete("Content-Type"):Array.isArray(i.headers)||delete i.headers["Content-Type"]),i.mode=this.requestMode,[4,this.timedFetch(e,i)];case 1:return n=o.sent(),a=n.headers,this._checkForDeprecationHeader(a),this._checkForBackoffHeader(a),(u=this._checkForRetryAfterHeader(a))&&s.retry>0?[2,this.retry(e,u,i,s)]:[2,this.processResponse(n)]}}))}))},t.prototype._checkForDeprecationHeader=function(t){var e=t.get("Alert");if(e){var r;try{r=JSON.parse(e)}catch(t){return void console.warn("Unable to parse Alert header message",e)}console.warn(r.message,r.url),this.events&&this.events.emit("deprecated",r)}},t.prototype._checkForBackoffHeader=function(t){var e,r=t.get("Backoff"),i=r?parseInt(r,10):0;e=i>0?(new Date).getTime()+1e3*i:0,this.events&&this.events.emit("backoff",e)},t.prototype._checkForRetryAfterHeader=function(t){var e=t.get("Retry-After");if(e){var r=1e3*parseInt(e,10),i=(new Date).getTime()+r;return this.events&&this.events.emit("retry-after",i),r}},t}(),R={root:function(){return"/"},batch:function(){return"/batch"},permissions:function(){return"/permissions"},bucket:function(t){return"/buckets"+(t?"/"+t:"")},history:function(t){return R.bucket(t)+"/history"},collection:function(t,e){return R.bucket(t)+"/collections"+(e?"/"+e:"")},group:function(t,e){return R.bucket(t)+"/groups"+(e?"/"+e:"")},record:function(t,e,r){return R.collection(t,e)+"/records"+(r?"/"+r:"")},attachment:function(t,e,r){return R.record(t,e,r)+"/attachment"}},k={safe:!1,headers:{},patch:!1};function S(t,e){return t?e?{"If-Match":'"'+e+'"'}:{"If-None-Match":"*"}:{}}function H(t,e,i){var n=e.data,o=e.permissions;void 0===i&&(i={});var s=r(r({},k),i),a=s.headers,u=s.safe;return{method:i.method||n&&n.id?"PUT":"POST",path:t,headers:r(r({},a),S(u)),body:{data:n,permissions:o}}}function T(t,e,i){var n=e.data,o=e.permissions;void 0===i&&(i={});var s=r(r({},k),i),a=s.headers,u=s.safe,c=s.patch,h=r(r({},n),i).last_modified;return n&&0===Object.keys(n).filter((function(t){return"id"!==t&&"last_modified"!==t})).length&&(n=void 0),{method:c?"PATCH":"PUT",path:t,headers:r(r({},a),S(u,h)),body:{data:n,permissions:o}}}function x(t,e,i,n){var o,u,c,h;void 0===n&&(n={});var d=r(r({},k),n),f=d.headers,l=d.safe,p=d.last_modified,v=[];try{for(var y=s(Object.entries(e)),g=y.next();!g.done;g=y.next()){var m=a(g.value,2),_=m[0],b=m[1];if(b)try{for(var w=(c=void 0,s(b)),R=w.next();!R.done;R=w.next()){var H=R.value;v.push({op:i,path:"/permissions/"+_+"/"+H})}}catch(t){c={error:t}}finally{try{R&&!R.done&&(h=w.return)&&h.call(w)}finally{if(c)throw c.error}}}}catch(t){o={error:t}}finally{try{g&&!g.done&&(u=y.return)&&u.call(y)}finally{if(o)throw o.error}}return{method:"PATCH",path:t,headers:r(r(r({},f),S(l,p)),{"Content-Type":"application/json-patch+json"}),body:v}}function E(t,e){void 0===e&&(e={});var i=r(r({},k),e),n=i.headers,o=i.safe,s=i.last_modified;if(o&&!s)throw new Error("Safe concurrency check requires a last_modified value.");return{method:"DELETE",path:t,headers:r(r({},n),S(o,s))}}function q(t,e,i,n){var o=void 0===i?{}:i,s=o.data,a=o.permissions;void 0===n&&(n={});var u=r(r({},k),n),c=u.headers,h=u.safe,d=u.gzipped,f=r(r({},s),n).last_modified,l=function(t,e,r){void 0===r&&(r={});var i=r.filename,n=void 0===i?"untitled":i,o=p(t),s=o.blob,a=o.name,u=new FormData;for(var c in u.append("attachment",s,a||n),e)void 0!==e[c]&&u.append(c,JSON.stringify(e[c]));return u}(e,{data:s,permissions:a},n);return{method:"POST",path:t+(null!==d?"?gzipped="+(d?"true":"false"):""),headers:r(r({},c),S(h,f)),body:l}}function A(t,e){if(void 0===t&&(t=[]),void 0===e&&(e=[]),t.length!==e.length)throw new Error("Responses length should match requests one.");return t.reduce((function(t,r,i){var n=r.status,o=e[i];if(n>=200&&n<400)t.published.push(r.body);else if(404===n){var s=o.path.match(/(buckets|groups|collections|records)\/([^/]+)$/),a=s&&3===s.length?s[2]:void 0;t.skipped.push({id:a,path:o.path,error:r.body})}else 412===n?t.conflicts.push({type:"outgoing",local:o.body,remote:r.body.details&&r.body.details.existing||null}):t.errors.push({path:o.path,sent:o,error:r.body});return t}),{errors:[],published:[],conflicts:[],skipped:[]})}var j="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto),P=new Uint8Array(16);function O(){if(!j)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return j(P)}for(var C=[],I=0;I<256;++I)C[I]=(I+256).toString(16).substr(1);function D(t,e,r){var i=e&&r||0;"string"==typeof t&&(e="binary"===t?new Array(16):null,t=null);var n=(t=t||{}).random||(t.rng||O)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,e)for(var o=0;o<16;++o)e[i+o]=n[o];return e||function(t,e){var r=e||0,i=C;return[i[t[r++]],i[t[r++]],i[t[r++]],i[t[r++]],"-",i[t[r++]],i[t[r++]],"-",i[t[r++]],i[t[r++]],"-",i[t[r++]],i[t[r++]],"-",i[t[r++]],i[t[r++]],i[t[r++]],i[t[r++]],i[t[r++]],i[t[r++]]].join("")}(n)}var U=function(){function t(t,e,i,n){void 0===n&&(n={}),this.client=t,this.bucket=e,this.name=i,this._endpoints=t.endpoints,this._retry=n.retry||0,this._safe=!!n.safe,this._headers=r(r({},this.bucket.headers),n.headers)}return t.prototype._getHeaders=function(t){return r(r({},this._headers),t.headers)},t.prototype._getSafe=function(t){return r({safe:this._safe},t).safe},t.prototype._getRetry=function(t){return r({retry:this._retry},t).retry},t.prototype.getTotalRecords=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e,r,i;return o(this,(function(n){switch(n.label){case 0:return e=this._endpoints.record(this.bucket.name,this.name),r={headers:this._getHeaders(t),path:e,method:"HEAD"},[4,this.client.execute(r,{raw:!0,retry:this._getRetry(t)})];case 1:return i=n.sent().headers,[2,parseInt(i.get("Total-Records"),10)]}}))}))},t.prototype.getRecordsTimestamp=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e,r;return o(this,(function(i){switch(i.label){case 0:return e=this._endpoints.record(this.bucket.name,this.name),r={headers:this._getHeaders(t),path:e,method:"HEAD"},[4,this.client.execute(r,{raw:!0,retry:this._getRetry(t)})];case 1:return[2,i.sent().headers.get("ETag")]}}))}))},t.prototype.getData=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e,r;return o(this,(function(i){switch(i.label){case 0:return e=this._endpoints.collection(this.bucket.name,this.name),r={headers:this._getHeaders(t),path:e},[4,this.client.execute(r,{retry:this._getRetry(t),query:t.query,fields:t.fields})];case 1:return[2,i.sent().data]}}))}))},t.prototype.setData=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s,a,u;return o(this,(function(o){if(!l(t))throw new Error("A collection object is required.");return i=e.patch,n=e.permissions,s=r(r({},t),e).last_modified,a=this._endpoints.collection(this.bucket.name,this.name),u=T(a,{data:t,permissions:n},{last_modified:s,patch:i,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(u,{retry:this._getRetry(e)})]}))}))},t.prototype.getPermissions=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e,r;return o(this,(function(i){switch(i.label){case 0:return e=this._endpoints.collection(this.bucket.name,this.name),r={headers:this._getHeaders(t),path:e},[4,this.client.execute(r,{retry:this._getRetry(t)})];case 1:return[2,i.sent().permissions]}}))}))},t.prototype.setPermissions=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){if(!l(t))throw new Error("A permissions object is required.");return r=this._endpoints.collection(this.bucket.name,this.name),i={last_modified:e.last_modified},n=T(r,{data:i,permissions:t},{headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(n,{retry:this._getRetry(e)})]}))}))},t.prototype.addPermissions=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){if(!l(t))throw new Error("A permissions object is required.");return r=this._endpoints.collection(this.bucket.name,this.name),i=e.last_modified,n=x(r,t,"add",{last_modified:i,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(n,{retry:this._getRetry(e)})]}))}))},t.prototype.removePermissions=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){if(!l(t))throw new Error("A permissions object is required.");return r=this._endpoints.collection(this.bucket.name,this.name),i=e.last_modified,n=x(r,t,"remove",{last_modified:i,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(n,{retry:this._getRetry(e)})]}))}))},t.prototype.createRecord=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){return r=e.permissions,i=this._endpoints.record(this.bucket.name,this.name,t.id),n=H(i,{data:t,permissions:r},{headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(n,{retry:this._getRetry(e)})]}))}))},t.prototype.addAttachment=function(t,e,i){return void 0===e&&(e={}),void 0===i&&(i={}),n(this,void 0,void 0,(function(){var n,s,a,u,c;return o(this,(function(o){switch(o.label){case 0:return n=i.permissions,s=e.id||D(),a=this._endpoints.attachment(this.bucket.name,this.name,s),u=r(r({},e),i).last_modified,c=q(a,t,{data:e,permissions:n},{last_modified:u,filename:i.filename,gzipped:i.gzipped,headers:this._getHeaders(i),safe:this._getSafe(i)}),[4,this.client.execute(c,{stringify:!1,retry:this._getRetry(i)})];case 1:return o.sent(),[2,this.getRecord(s)]}}))}))},t.prototype.removeAttachment=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){return r=e.last_modified,i=this._endpoints.attachment(this.bucket.name,this.name,t),n=E(i,{last_modified:r,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(n,{retry:this._getRetry(e)})]}))}))},t.prototype.updateRecord=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s,a;return o(this,(function(o){if(!l(t))throw new Error("A record object is required.");if(!t.id)throw new Error("A record id is required.");return i=e.permissions,n=r(r({},t),e).last_modified,s=this._endpoints.record(this.bucket.name,this.name,t.id),a=T(s,{data:t,permissions:i},{headers:this._getHeaders(e),safe:this._getSafe(e),last_modified:n,patch:!!e.patch}),[2,this.client.execute(a,{retry:this._getRetry(e)})]}))}))},t.prototype.deleteRecord=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s,a,c;return o(this,(function(o){if(!(i=u(t)).id)throw new Error("A record id is required.");return n=i.id,s=r(r({},i),e).last_modified,a=this._endpoints.record(this.bucket.name,this.name,n),c=E(a,{last_modified:s,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(c,{retry:this._getRetry(e)})]}))}))},t.prototype.getRecord=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i;return o(this,(function(n){return r=this._endpoints.record(this.bucket.name,this.name,t),i={headers:this._getHeaders(e),path:r},[2,this.client.execute(i,{retry:this._getRetry(e),query:e.query,fields:e.fields})]}))}))},t.prototype.listRecords=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e;return o(this,(function(r){return e=this._endpoints.record(this.bucket.name,this.name),t.at?[2,this.getSnapshot(t.at)]:[2,this.client.paginatedList(e,t,{headers:this._getHeaders(t),retry:this._getRetry(t)})]}))}))},t.prototype.isHistoryComplete=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return[4,this.bucket.listHistory({limit:1,filters:{action:"create",resource_name:"collection",collection_id:this.name}})];case 1:return t=a.apply(void 0,[e.sent().data,1]),[2,!!t[0]]}}))}))},t.prototype.listChangesBackTo=function(t){return n(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.isHistoryComplete()];case 1:if(!e.sent())throw new Error("Computing a snapshot is only possible when the full history for a collection is available. Here, the history plugin seems to have been enabled after the creation of the collection.");return[4,this.bucket.listHistory({pages:1/0,sort:"-target.data.last_modified",filters:{resource_name:"record",collection_id:this.name,"max_target.data.last_modified":String(t)}})];case 2:return[2,e.sent().data]}}))}))},t.prototype.getSnapshot=function(t){return n(this,void 0,void 0,(function(){var e,r,i,n,a,u,c,h,d,f,l;return o(this,(function(o){switch(o.label){case 0:if(!t||!Number.isInteger(t)||t<=0)throw new Error("Invalid argument, expected a positive integer.");return[4,this.listChangesBackTo(t)];case 1:e=o.sent(),r=new Set,i=[],n=function(t,e){"delete"==t?(r.add(e.id),i=i.filter((function(t){return t.id!==e.id}))):r.has(e.id)||(r.add(e.id),i.push(e))};try{for(a=s(e),u=a.next();!u.done;u=a.next())c=u.value,h=c.action,d=c.target.data,n(h,d)}catch(t){f={error:t}}finally{try{u&&!u.done&&(l=a.return)&&l.call(a)}finally{if(f)throw f.error}}return[2,{last_modified:String(t),data:i.sort((function(t,e){return e.last_modified-t.last_modified})),next:function(){throw new Error("Snapshots don't support pagination")},hasNextPage:!1,totalRecords:i.length}]}}))}))},t.prototype.batch=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){return o(this,(function(r){return[2,this.client.batch(t,{bucket:this.bucket.name,collection:this.name,headers:this._getHeaders(e),retry:this._getRetry(e),safe:this._getSafe(e),aggregate:!!e.aggregate})]}))}))},i([d(["attachments"])],t.prototype,"addAttachment",null),i([d(["attachments"])],t.prototype,"removeAttachment",null),i([d(["history"])],t.prototype,"getSnapshot",null),t}(),B=function(){function t(t,e,r){void 0===r&&(r={}),this.client=t,this.name=e,this._endpoints=t.endpoints,this._headers=r.headers||{},this._retry=r.retry||0,this._safe=!!r.safe}return Object.defineProperty(t.prototype,"headers",{get:function(){return this._headers},enumerable:!0,configurable:!0}),t.prototype._getHeaders=function(t){return r(r({},this._headers),t.headers)},t.prototype._getSafe=function(t){return r({safe:this._safe},t).safe},t.prototype._getRetry=function(t){return r({retry:this._retry},t).retry},t.prototype.collection=function(t,e){return void 0===e&&(e={}),new U(this.client,this,t,{headers:this._getHeaders(e),retry:this._getRetry(e),safe:this._getSafe(e)})},t.prototype.getCollectionsTimestamp=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e,r;return o(this,(function(i){switch(i.label){case 0:return e=this._endpoints.collection(this.name),r={headers:this._getHeaders(t),path:e,method:"HEAD"},[4,this.client.execute(r,{raw:!0,retry:this._getRetry(t)})];case 1:return[2,i.sent().headers.get("ETag")]}}))}))},t.prototype.getGroupsTimestamp=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e,r;return o(this,(function(i){switch(i.label){case 0:return e=this._endpoints.group(this.name),r={headers:this._getHeaders(t),path:e,method:"HEAD"},[4,this.client.execute(r,{raw:!0,retry:this._getRetry(t)})];case 1:return[2,i.sent().headers.get("ETag")]}}))}))},t.prototype.getData=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e,r;return o(this,(function(i){switch(i.label){case 0:return e=this._endpoints.bucket(this.name),r={headers:this._getHeaders(t),path:e},[4,this.client.execute(r,{retry:this._getRetry(t),query:t.query,fields:t.fields})];case 1:return[2,i.sent().data]}}))}))},t.prototype.setData=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s,a,u,c,h;return o(this,(function(o){if(!l(t))throw new Error("A bucket object is required.");return i=r(r({},t),{id:this.name}),n=i.id,"default"===i.id&&delete i.id,s=this._endpoints.bucket(n),a=e.patch,u=e.permissions,c=r(r({},t),e).last_modified,h=T(s,{data:i,permissions:u},{last_modified:c,patch:a,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(h,{retry:this._getRetry(e)})]}))}))},t.prototype.listHistory=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e;return o(this,(function(r){return e=this._endpoints.history(this.name),[2,this.client.paginatedList(e,t,{headers:this._getHeaders(t),retry:this._getRetry(t)})]}))}))},t.prototype.listCollections=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e;return o(this,(function(r){return e=this._endpoints.collection(this.name),[2,this.client.paginatedList(e,t,{headers:this._getHeaders(t),retry:this._getRetry(t)})]}))}))},t.prototype.createCollection=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n,s,a;return o(this,(function(o){return r=e.permissions,i=e.data,(n=void 0===i?{}:i).id=t,s=this._endpoints.collection(this.name,t),a=H(s,{data:n,permissions:r},{headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(a,{retry:this._getRetry(e)})]}))}))},t.prototype.deleteCollection=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s,a,c;return o(this,(function(o){if(!(i=u(t)).id)throw new Error("A collection id is required.");return n=i.id,s=r(r({},i),e).last_modified,a=this._endpoints.collection(this.name,n),c=E(a,{last_modified:s,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(c,{retry:this._getRetry(e)})]}))}))},t.prototype.listGroups=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e;return o(this,(function(r){return e=this._endpoints.group(this.name),[2,this.client.paginatedList(e,t,{headers:this._getHeaders(t),retry:this._getRetry(t)})]}))}))},t.prototype.getGroup=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i;return o(this,(function(n){return r=this._endpoints.group(this.name,t),i={headers:this._getHeaders(e),path:r},[2,this.client.execute(i,{retry:this._getRetry(e),query:e.query,fields:e.fields})]}))}))},t.prototype.createGroup=function(t,e,i){return void 0===e&&(e=[]),void 0===i&&(i={}),n(this,void 0,void 0,(function(){var n,s,a,u;return o(this,(function(o){return n=r(r({},i.data),{id:t,members:e}),s=this._endpoints.group(this.name,t),a=i.permissions,u=H(s,{data:n,permissions:a},{headers:this._getHeaders(i),safe:this._getSafe(i)}),[2,this.client.execute(u,{retry:this._getRetry(i)})]}))}))},t.prototype.updateGroup=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s,a,u,c;return o(this,(function(o){if(!l(t))throw new Error("A group object is required.");if(!t.id)throw new Error("A group id is required.");return i=r(r({},e.data),t),n=this._endpoints.group(this.name,t.id),s=e.patch,a=e.permissions,u=r(r({},i),e).last_modified,c=T(n,{data:i,permissions:a},{last_modified:u,patch:s,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(c,{retry:this._getRetry(e)})]}))}))},t.prototype.deleteGroup=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s,a,c;return o(this,(function(o){return i=u(t),n=i.id,s=r(r({},i),e).last_modified,a=this._endpoints.group(this.name,n),c=E(a,{last_modified:s,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(c,{retry:this._getRetry(e)})]}))}))},t.prototype.getPermissions=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e;return o(this,(function(r){switch(r.label){case 0:return e={headers:this._getHeaders(t),path:this._endpoints.bucket(this.name)},[4,this.client.execute(e,{retry:this._getRetry(t)})];case 1:return[2,r.sent().permissions]}}))}))},t.prototype.setPermissions=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){if(!l(t))throw new Error("A permissions object is required.");return r=this._endpoints.bucket(this.name),i=e.last_modified,n=T(r,{data:{last_modified:i},permissions:t},{headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(n,{retry:this._getRetry(e)})]}))}))},t.prototype.addPermissions=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){if(!l(t))throw new Error("A permissions object is required.");return r=this._endpoints.bucket(this.name),i=e.last_modified,n=x(r,t,"add",{last_modified:i,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(n,{retry:this._getRetry(e)})]}))}))},t.prototype.removePermissions=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){if(!l(t))throw new Error("A permissions object is required.");return r=this._endpoints.bucket(this.name),i=e.last_modified,n=x(r,t,"remove",{last_modified:i,headers:this._getHeaders(e),safe:this._getSafe(e)}),[2,this.client.execute(n,{retry:this._getRetry(e)})]}))}))},t.prototype.batch=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){return o(this,(function(r){return[2,this.client.batch(t,{bucket:this.name,headers:this._getHeaders(e),retry:this._getRetry(e),safe:this._getSafe(e),aggregate:!!e.aggregate})]}))}))},i([d(["history"])],t.prototype,"listHistory",null),t}();return function(t){function r(e,r){void 0===r&&(r={});var i=r.events;return t.call(this,e,Object.assign({events:i},r))||this}return e(r,t),r}(function(){function t(t,e){if("string"!=typeof t||!t.length)throw new Error("Invalid remote URL: "+t);"/"===t[t.length-1]&&(t=t.slice(0,-1)),this._backoffReleaseTime=null,this._requests=[],this._isBatch=!!e.batch,this._retry=e.retry||0,this._safe=!!e.safe,this._headers=e.headers||{},this.remote=t,this.serverInfo=null,this.events=e.events,this.endpoints=R;var r=e.requestMode,i=e.timeout;this.http=new w(this.events,{requestMode:r,timeout:i}),this._registerHTTPEvents()}var e,l;return Object.defineProperty(t.prototype,"remote",{get:function(){return this._remote},set:function(t){var e;try{e=t.match(/\/(v\d+)\/?$/)[1]}catch(e){throw new Error("The remote URL must contain the version: "+t)}if("v1"!==e)throw new Error("Unsupported protocol version: "+e);this._remote=t,this._version=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"backoff",{get:function(){var t=(new Date).getTime();return this._backoffReleaseTime&&t<this._backoffReleaseTime?this._backoffReleaseTime-t:0},enumerable:!0,configurable:!0}),t.prototype._registerHTTPEvents=function(){var t=this;!this._isBatch&&this.events&&this.events.on("backoff",(function(e){t._backoffReleaseTime=e}))},t.prototype.bucket=function(t,e){return void 0===e&&(e={}),new B(this,t,{headers:this._getHeaders(e),safe:this._getSafe(e),retry:this._getRetry(e)})},t.prototype.setHeaders=function(t){this._headers=r(r({},this._headers),t),this.serverInfo=null},t.prototype._getHeaders=function(t){return r(r({},this._headers),t.headers)},t.prototype._getSafe=function(t){return r({safe:this._safe},t).safe},t.prototype._getRetry=function(t){return r({retry:this._retry},t).retry},t.prototype._getHello=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e;return o(this,(function(r){switch(r.label){case 0:return e=this.remote+R.root(),[4,this.http.request(e,{headers:this._getHeaders(t)},{retry:this._getRetry(t)})];case 1:return[2,r.sent().json]}}))}))},t.prototype.fetchServerInfo=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e;return o(this,(function(r){switch(r.label){case 0:return this.serverInfo?[2,this.serverInfo]:(e=this,[4,this._getHello({retry:this._getRetry(t)})]);case 1:return e.serverInfo=r.sent(),[2,this.serverInfo]}}))}))},t.prototype.fetchServerSettings=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.fetchServerInfo(t)];case 1:return[2,e.sent().settings]}}))}))},t.prototype.fetchServerCapabilities=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.fetchServerInfo(t)];case 1:return[2,e.sent().capabilities]}}))}))},t.prototype.fetchUser=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this._getHello(t)];case 1:return[2,e.sent().user]}}))}))},t.prototype.fetchHTTPApiVersion=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.fetchServerInfo(t)];case 1:return[2,e.sent().http_api_version]}}))}))},t.prototype._batchRequests=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,i,n,u,c,h,d,f,l,p,v,y;return o(this,(function(o){switch(o.label){case 0:return r=this._getHeaders(e),t.length?[4,this.fetchServerSettings({retry:this._getRetry(e)})]:[2,[]];case 1:if(i=o.sent(),!((n=i.batch_max_requests)&&t.length>n))return[3,10];g=t,u=(m=n)<=0?[g]:g.reduce((function(t,e,r){return 0===r||r%m==0?t.push([e]):t[t.length-1].push(e),t}),[]),c=[],o.label=2;case 2:o.trys.push([2,7,8,9]),h=s(u),d=h.next(),o.label=3;case 3:return d.done?[3,6]:(f=d.value,[4,this._batchRequests(f,e)]);case 4:l=o.sent(),c.push.apply(c,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(a(arguments[e]));return t}(l)),o.label=5;case 5:return d=h.next(),[3,3];case 6:return[3,9];case 7:return p=o.sent(),v={error:p},[3,9];case 8:try{d&&!d.done&&(y=h.return)&&y.call(h)}finally{if(v)throw v.error}return[7];case 9:return[2,c];case 10:return[4,this.execute({headers:r,path:R.batch(),method:"POST",body:{defaults:{headers:r},requests:t}},{retry:this._getRetry(e)})];case 11:return[2,o.sent().responses]}var g,m}))}))},t.prototype.batch=function(e,r){return void 0===r&&(r={}),n(this,void 0,void 0,(function(){var i,n;return o(this,(function(o){switch(o.label){case 0:return i=new t(this.remote,{events:this.events,batch:!0,safe:this._getSafe(r),retry:this._getRetry(r)}),r.bucket&&r.collection?e(i.bucket(r.bucket).collection(r.collection)):r.bucket?e(i.bucket(r.bucket)):e(i),[4,this._batchRequests(i._requests,r)];case 1:return n=o.sent(),r.aggregate?[2,A(n,i._requests)]:[2,n]}}))}))},t.prototype.execute=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s,a,u,h,d;return o(this,(function(o){switch(o.label){case 0:return i=e.raw,n=void 0!==i&&i,s=e.stringify,a=void 0===s||s,this._isBatch?(this._requests.push(t),u="This result is generated from within a batch operation and should not be consumed.",[2,n?{status:0,json:u,headers:new Headers}:u]):(h=this.remote+function(t,e){void 0===e&&(e={});var i=r({},e.query);e.fields&&(i._fields=e.fields);var n=c(i);return n?t+"?"+n:t}(t.path,e),[4,this.http.request(h,v({method:t.method,headers:t.headers,body:a?JSON.stringify(t.body):t.body}),{retry:this._getRetry(e)})]);case 1:return d=o.sent(),[2,n?d:d.json]}}))}))},t.prototype.paginatedList=function(t,e,i){return void 0===e&&(e={}),void 0===i&&(i={}),n(this,void 0,void 0,(function(){var s,a,u,h,d,f,l,p,v,y,g,m,_,b,w,R,k=this;return o(this,(function(S){switch(S.label){case 0:if(s=r({sort:"-last_modified"},e),a=s.sort,u=s.filters,h=s.limit,d=s.pages,f=s.since,l=s.fields,f&&"string"!=typeof f)throw new Error("Invalid value for since ("+f+"), should be ETag value.");return p=r(r({},u),{_sort:a,_limit:h,_since:f}),l&&(p._fields=l),v=c(p),y=[],g=0,m=function(t){return n(this,void 0,void 0,(function(){return o(this,(function(e){if(!t)throw new Error("Pagination exhausted.");return[2,_(t)]}))}))},_=function(t){return n(k,void 0,void 0,(function(){var e,r;return o(this,(function(n){switch(n.label){case 0:return e=i.headers,r=w,[4,this.http.request(t,{headers:e})];case 1:return[2,r.apply(void 0,[n.sent()])]}}))}))},b=function(t,e,r){return{last_modified:r?r.replace(/"/g,""):r,data:t,next:m.bind(null,e),hasNextPage:!!e,totalRecords:-1}},R=w=function(t){var e=t.headers,r=t.json;return n(this,void 0,void 0,(function(){var t,i;return o(this,(function(n){return t=e.get("Next-Page"),i=e.get("ETag"),d?(y=y.concat(r.data),(g+=1)>=d||!t?[2,b(y,t,i)]:[2,_(t)]):[2,b(r.data,t,i)]}))}))},[4,this.execute({headers:i.headers?i.headers:{},path:t+"?"+v},{raw:!0,retry:i.retry||0})];case 1:return[2,R.apply(void 0,[S.sent()])]}}))}))},t.prototype.listPermissions=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e,i;return o(this,(function(n){return e=R.permissions(),i=r({sort:"id"},t),[2,this.paginatedList(e,i,{headers:this._getHeaders(t),retry:this._getRetry(t)})]}))}))},t.prototype.listBuckets=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e;return o(this,(function(r){return e=R.bucket(),[2,this.paginatedList(e,t,{headers:this._getHeaders(t),retry:this._getRetry(t)})]}))}))},t.prototype.createBucket=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s,a;return o(this,(function(o){return i=e.data,n=e.permissions,s=r(r({},i),{id:t||void 0}),a=s.id?R.bucket(s.id):R.bucket(),[2,this.execute(H(a,{data:s,permissions:n},{headers:this._getHeaders(e),safe:this._getSafe(e)}),{retry:this._getRetry(e)})]}))}))},t.prototype.deleteBucket=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var i,n,s;return o(this,(function(o){if(!(i=u(t)).id)throw new Error("A bucket id is required.");return n=R.bucket(i.id),s=r(r({},i),e).last_modified,[2,this.execute(E(n,{last_modified:s,headers:this._getHeaders(e),safe:this._getSafe(e)}),{retry:this._getRetry(e)})]}))}))},t.prototype.deleteBuckets=function(t){return void 0===t&&(t={}),n(this,void 0,void 0,(function(){var e;return o(this,(function(r){return e=R.bucket(),[2,this.execute(E(e,{last_modified:t.last_modified,headers:this._getHeaders(t),safe:this._getSafe(t)}),{retry:this._getRetry(t)})]}))}))},t.prototype.createAccount=function(t,e){return n(this,void 0,void 0,(function(){return o(this,(function(r){return[2,this.execute(H("/accounts/"+t,{data:{password:e}},{method:"PUT"}))]}))}))},i([f("This operation is not supported within a batch operation.")],t.prototype,"fetchServerSettings",null),i([f("This operation is not supported within a batch operation.")],t.prototype,"fetchServerCapabilities",null),i([f("This operation is not supported within a batch operation.")],t.prototype,"fetchUser",null),i([f("This operation is not supported within a batch operation.")],t.prototype,"fetchHTTPApiVersion",null),i([f("Can't use batch within a batch!")],t.prototype,"batch",null),i([d(["permissions_endpoint"])],t.prototype,"listPermissions",null),i([(e="1.4",l="2.0",function(t,r,i){var n=i.value;return{configurable:!0,get:function(){var t=this,i=function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];var o=t.client?t.client:t;return o.fetchHTTPApiVersion().then((function(t){return h(t,e,l)})).then((function(){return n.apply(t,r)}))};return Object.defineProperty(this,r,{value:i,configurable:!0,writable:!0}),i}}})],t.prototype,"deleteBuckets",null),i([d(["accounts"])],t.prototype,"createAccount",null),t}())}));
//# sourceMappingURL=kinto-http.min.js.map
